<div class="signup-wrapper">
  <header class="signup-header">
    <span class="auth-brand">
      <svg
        aria-hidden="true"
        width="20"
        height="20"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="1.5"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M12 22c5-2 8-5.33 8-10V7l-8-4-8 4v5c0 4.67 3 8 8 10Z"></path>
        <path d="M9 11.5 11.25 14 15 10"></path>
      </svg>
      DigiClin
    </span>
    <h1 class="signup-heading">Crea tu cuenta</h1>
    <p class="signup-subheading">
      Gestiona tus citas y tu historial médico en un solo lugar.
    </p>
  </header>

  <form id="signup-form" class="signup-form" novalidate>
    <!-- Nombre completo -->
    <div class="signup-field">
      <label class="signup-label" for="fullName">Nombre completo</label>
      <div class="signup-input-wrapper">
        <span class="signup-input-icon">
          <svg
            class="auth-icon auth-icon--user"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
              d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0"></path><path
              d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path></svg
          >
        </span>
        <input
          class="signup-input"
          type="text"
          id="fullName"
          name="fullName"
          placeholder="Ingresa tu nombre completo"
          required
        />
      </div>
    </div>

    <!-- Rol -->
    <div class="signup-field">
      <label class="signup-label" for="role">Rol</label>
      <div class="signup-input-wrapper">
        <span class="signup-input-icon">
          <svg
            class="auth-icon auth-icon--role"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
              d="M9 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0"></path><path
              d="M3 21v-2a4 4 0 0 1 4 -4h4"></path><path d="M16 21l2 -2l2 2"></path><path d="M18 17v4"></path></svg
          >
        </span>
        <select
          class="signup-input signup-select"
          id="role"
          name="role"
          required
          aria-label="Selecciona el rol para la cuenta"
        >
          <option value="" disabled selected>Selecciona un rol</option>
          <option value="patient">Paciente</option>
          <option value="doctor">Doctor</option>
          <option value="admin">Administrador</option>
        </select>
      </div>
    </div>

    <!-- Correo -->
    <div class="signup-field">
      <label class="signup-label" for="email">Correo electrónico</label>
      <div class="signup-input-wrapper">
        <span class="signup-input-icon">
          <svg
            class="auth-icon icon icon-tabler icon-tabler-mail"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
              d="M3 7a2 2 0 0 1 2 -2h14a2 2 0 0 1 2 2v10a2 2 0 0 1 -2 2h-14a2 2 0 0 1 -2 -2v-10z"
            ></path><path d="M3 7l9 6l9 -6"></path></svg
          >
        </span>
        <input
          class="signup-input"
          type="email"
          id="email"
          name="email"
          placeholder="tu@email.com"
          required
        />
      </div>
    </div>

    <!-- Contraseña -->
    <div class="signup-field">
      <label class="signup-label" for="password">Contraseña</label>
      <div class="signup-input-wrapper">
        <span class="signup-input-icon">
          <svg
            class="auth-icon auth-icon--lock"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
              d="M5 13a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-6z"
            ></path><path d="M11 16a1 1 0 1 0 2 0a1 1 0 0 0 -2 0"></path><path
              d="M8 11v-4a4 4 0 1 1 8 0v4"></path></svg
          >
        </span>
        <input
          class="signup-input"
          type="password"
          id="password"
          name="password"
          placeholder="Crea una contraseña segura"
          required
        />
        <button
          type="button"
          id="toggle-password"
          class="signup-input-action"
          aria-label="Mostrar u ocultar contraseña"
        >
          <svg
            id="icon-signup-eye"
            class="auth-input-action-icon auth-input-action-icon--hidden icon icon-tabler icon-tabler-eye"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
              d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0"></path><path
              d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6"
            ></path></svg
          >
          <svg
            id="icon-signup-eye-off"
            class="auth-input-action-icon icon icon-tabler icon-tabler-eye-off"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
              d="M10.585 10.587a2 2 0 0 0 2.829 2.828"></path><path
              d="M16.681 16.673a8.717 8.717 0 0 1 -4.681 1.327c-3.6 0 -6.6 -2 -9 -6c1.272 -2.12 2.712 -3.678 4.32 -4.674m2.86 -1.146a9.055 9.055 0 0 1 1.82 -.18c3.6 0 6.6 2 9 6c-.666 1.11 -1.379 2.067 -2.138 2.87"
            ></path><path d="M3 3l18 18"></path></svg
          >
        </button>
      </div>
      <div class="signup-strength">
        <span>Débil</span>
        <div class="signup-strength__track">
          <span class="signup-strength__bar" id="password-strength"></span>
        </div>
        <span>Fuerte</span>
      </div>
    </div>

    <!-- Confirmar contraseña -->
    <div class="signup-field">
      <label class="signup-label" for="confirmPassword"
        >Confirmar contraseña</label
      >
      <div class="signup-input-wrapper">
        <span class="signup-input-icon">
          <svg
            class="auth-icon auth-icon--lock"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
              d="M5 13a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-6z"
            ></path><path d="M11 16a1 1 0 1 0 2 0a1 1 0 0 0 -2 0"></path><path
              d="M8 11v-4a4 4 0 1 1 8 0v4"></path></svg
          >
        </span>
        <input
          class="signup-input"
          type="password"
          id="confirmPassword"
          name="confirmPassword"
          placeholder="Vuelve a escribir la contraseña"
          required
        />
        <button
          type="button"
          id="toggle-confirm-password"
          class="signup-input-action"
          aria-label="Mostrar u ocultar confirmación"
        >
          <svg
            id="icon-signup-eye-confirm"
            class="auth-input-action-icon auth-input-action-icon--hidden icon icon-tabler icon-tabler-eye"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
              d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0"></path><path
              d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6"
            ></path></svg
          >
          <svg
            id="icon-signup-eye-off-confirm"
            class="auth-input-action-icon icon icon-tabler icon-tabler-eye-off"
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
              d="M10.585 10.587a2 2 0 0 0 2.829 2.828"></path><path
              d="M16.681 16.673a8.717 8.717 0 0 1 -4.681 1.327c-3.6 0 -6.6 -2 -9 -6c1.272 -2.12 2.712 -3.678 4.32 -4.674m2.86 -1.146a9.055 9.055 0 0 1 1.82 -.18c3.6 0 6.6 2 9 6c-.666 1.11 -1.379 2.067 -2.138 2.87"
            ></path><path d="M3 3l18 18"></path></svg
          >
        </button>
      </div>
    </div>

    <!-- Checkbox términos -->
    <label class="signup-checkbox">
      <input type="checkbox" id="terms" required />
      <span
        >Acepto los <a class="signup-link" href="#">términos y condiciones</a
        ></span
      >
    </label>

    <!-- Error y botón -->
    <p id="error-message" class="signup-error" role="alert"></p>
    <button id="submit-button" type="submit" class="signup-submit"
      >Crear Cuenta</button
    >
  </form>

  <footer class="signup-footer">
    ¿Ya tienes una cuenta? <a class="signup-link" href="/login">Inicia sesión</a
    >
  </footer>
</div>

<script>
  import AuthModule from "../auth/authModule.js";

  const form = document.querySelector<HTMLFormElement>("#signup-form");
  const submitButton =
    document.querySelector<HTMLButtonElement>("#submit-button");
  const errorMessageEl =
    document.querySelector<HTMLParagraphElement>("#error-message");
  const passwordInput = document.querySelector<HTMLInputElement>("#password");
  const confirmInput =
    document.querySelector<HTMLInputElement>("#confirmPassword");
  const togglePassword =
    document.querySelector<HTMLButtonElement>("#toggle-password");
  const toggleConfirmPassword = document.querySelector<HTMLButtonElement>(
    "#toggle-confirm-password"
  );
  const eye = document.querySelector<SVGElement>("#icon-signup-eye");
  const eyeOff = document.querySelector<SVGElement>("#icon-signup-eye-off");
  const eyeConfirm = document.querySelector<SVGElement>(
    "#icon-signup-eye-confirm"
  );
  const eyeOffConfirm = document.querySelector<SVGElement>(
    "#icon-signup-eye-off-confirm"
  );
  const strengthBar =
    document.querySelector<HTMLSpanElement>("#password-strength");

  const toggleVisibility = (
    input: HTMLInputElement | null,
    primary?: SVGElement | null,
    secondary?: SVGElement | null
  ) => {
    if (!input) return;
    const hidden = input.type === "password";
    input.type = hidden ? "text" : "password";
    primary?.classList.toggle("auth-input-action-icon--hidden", !hidden);
    secondary?.classList.toggle("auth-input-action-icon--hidden", hidden);
  };

  togglePassword?.addEventListener("click", () =>
    toggleVisibility(passwordInput, eye, eyeOff)
  );
  toggleConfirmPassword?.addEventListener("click", () =>
    toggleVisibility(confirmInput, eyeConfirm, eyeOffConfirm)
  );

  passwordInput?.addEventListener("input", () => {
    if (!strengthBar || !passwordInput) return;
    const value = passwordInput.value.trim();
    const score = Math.min(
      1,
      value.length / 12 +
        (/[A-Z]/.test(value) ? 0.2 : 0) +
        (/[0-9]/.test(value) ? 0.2 : 0) +
        (/[^a-zA-Z0-9]/.test(value) ? 0.2 : 0)
    );
    strengthBar.style.width = `${Math.max(0.1, score) * 100}%`;
  });

  if (form && submitButton && errorMessageEl) {
    const originalButtonText = submitButton.textContent;
    form.addEventListener("submit", async (event: SubmitEvent) => {
      event.preventDefault();
      errorMessageEl.textContent = "";

      if (!passwordInput || !confirmInput) return;
      if (passwordInput.value !== confirmInput.value) {
        errorMessageEl.textContent = "Las contraseñas no coinciden.";
        return;
      }
      const terms = document.querySelector<HTMLInputElement>("#terms");
      if (terms && !terms.checked) {
        errorMessageEl.textContent =
          "Debes aceptar los términos y condiciones.";
        return;
      }

      submitButton.disabled = true;
      submitButton.textContent = "Creando cuenta...";

      const formData = new FormData(form);
      const fullName = formData.get("fullName") as string;
      const email = formData.get("email") as string;
      const password = formData.get("password") as string;
      const role = formData.get("role") as string;

      if (!role) {
        errorMessageEl.textContent = "Selecciona un rol para continuar.";
        submitButton.disabled = false;
        submitButton.textContent = originalButtonText;
        return;
      }

      try {
        await AuthModule.register({ fullName, email, password, role });
        const parent = form.parentElement;
        if (parent) {
          parent.innerHTML = `
            <div class="signup-success">
              <h2>¡Registro exitoso!</h2>
              <p>Hemos enviado un enlace de verificación a tu correo. Revisa tu bandeja de entrada.</p>
              <a href="/login">Volver a iniciar sesión</a>
            </div>
          `;
        }
      } catch (error: any) {
        console.error("Signup failed:", error);
        const errorData = error?.response
          ? await error.response.json().catch(() => null)
          : null;
        const backendMessage =
          errorData?.error ?? errorData?.message ?? error?.message;
        errorMessageEl.textContent =
          backendMessage ?? "Ocurrió un error inesperado.";
      } finally {
        if (form.parentElement) {
          submitButton.disabled = false;
          submitButton.textContent = originalButtonText;
        }
      }
    });
  }
</script>

<style>
  .signup-wrapper {
    display: flex;
    flex-direction: column;
    gap: clamp(1.4rem, 2.4vw, 2.1rem);
  }

  .signup-header {
    display: grid;
    gap: 0.75rem;
  }

  .signup-heading {
    font-size: clamp(2rem, 4.2vw, 2.5rem);
    font-weight: 700;
    color: var(--auth-heading);
  }

  .signup-subheading {
    color: var(--auth-body);
    font-size: 1rem;
    line-height: 1.5;
  }

  .signup-form {
    display: flex;
    flex-direction: column;
    gap: 1.05rem;
  }

  .signup-field {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .signup-label {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--auth-body);
  }

  .signup-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }

  .signup-input-icon {
    position: absolute;
    left: 1rem;
    display: inline-flex;
    color: var(--auth-muted);
  }

  .signup-input {
    width: 100%;
    border-radius: 18px;
    border: 1px solid var(--auth-input-border);
    background: var(--auth-input-bg);
    padding: 0.9rem 3.1rem 0.9rem 3.1rem;
    font-size: 1rem;
    color: var(--auth-heading);
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .signup-select {
    cursor: pointer;
  }

  .signup-input:focus {
    border-color: var(--auth-primary);
    box-shadow: 0 0 0 4px rgba(29, 78, 216, 0.15);
    outline: none;
  }

  .signup-input::placeholder {
    color: var(--auth-muted);
  }

  .signup-input-action {
    position: absolute;
    right: 1rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    color: var(--auth-muted);
    cursor: pointer;
  }

  .signup-strength {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.75rem;
    color: var(--auth-muted);
  }

  .signup-strength__track {
    flex: 1;
    height: 6px;
    border-radius: 999px;
    background: rgba(148, 163, 184, 0.25);
    position: relative;
    overflow: hidden;
  }

  .signup-strength__bar {
    position: absolute;
    inset: 0;
    width: 30%;
    border-radius: inherit;
    background: linear-gradient(90deg, #ef4444, #f97316, #facc15, #22c55e);
    transition: width 0.25s ease;
  }

  .signup-checkbox {
    display: flex;
    align-items: flex-start;
    gap: 0.6rem;
    font-size: 0.85rem;
    color: var(--auth-muted);
  }

  .signup-checkbox input {
    margin-top: 0.1rem;
    width: 1rem;
    height: 1rem;
    border-radius: 5px;
    border: 1px solid var(--auth-input-border);
    accent-color: var(--auth-primary);
  }

  .signup-link {
    color: var(--auth-link);
    font-weight: 600;
    text-decoration: none;
  }

  .signup-link:hover {
    text-decoration: underline;
  }

  .signup-error {
    min-height: 1.25rem;
    text-align: center;
    color: #ef4444;
    font-size: 0.9rem;
  }

  .signup-submit {
    width: 100%;
    border: none;
    border-radius: 18px;
    padding: 1rem;
    font-size: 1rem;
    font-weight: 600;
    color: #fff;
    background: var(--auth-primary);
    box-shadow: 0 24px 40px -24px rgba(29, 78, 216, 0.6);
    cursor: pointer;
    transition: transform 0.2s ease, background 0.2s ease, box-shadow 0.2s ease;
  }

  .signup-submit:hover {
    background: var(--auth-primary-hover);
    transform: translateY(-2px);
  }

  .signup-submit:disabled {
    background: rgba(148, 163, 184, 0.5);
    box-shadow: none;
    cursor: not-allowed;
    transform: none;
  }

  .signup-footer {
    text-align: center;
    font-size: 0.95rem;
    color: var(--auth-muted);
  }

  .signup-success {
    text-align: center;
    display: grid;
    gap: 1rem;
  }

  .signup-success h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--auth-heading);
  }

  .signup-success p {
    color: var(--auth-body);
  }

  .signup-success a {
    color: var(--auth-link);
    font-weight: 600;
    text-decoration: none;
  }

  .signup-success a:hover {
    text-decoration: underline;
  }
</style>
