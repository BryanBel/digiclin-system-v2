---
import Layout from '../../layouts/Layout.astro';
import medicalHistoryClient from './medical-history.client.js?url';

const user = (Astro.locals as any)?.user ?? null;
const isDoctor = user?.role === 'doctor';
const canEdit = isDoctor;
---

<Layout title="DigiClin | Historial médico">
  <section class="admin-shell">
    <header class="admin-header">
      <h1>Historial médico</h1>
      <p class="admin-subtitle">
        Consulta y actualiza los registros clínicos de los pacientes.
      </p>
    </header>

    <div class="admin-grid">
      <div class="admin-card">
        <div class="admin-toolbar admin-toolbar--history">
          <input
            type="search"
            class="admin-search"
            placeholder="Buscar por paciente, documento o doctor"
            data-history-search
          />
          <button
            type="button"
            class="admin-button admin-button--primary"
            data-open-history-create
            hidden={!canEdit}
          >
            Registrar historial
          </button>
        </div>

        <div class="records-table-wrapper">
          <table class="records-table records-table--history">
            <thead>
              <tr>
                <th>Paciente</th>
                <th>Fecha</th>
                <th>Motivo / Diagnóstico</th>
                <th>Tratamiento</th>
                <th>Receta</th>
                <th>Doctor</th>
              </tr>
            </thead>
            <tbody data-history-body>
              <tr class="records-empty">
                <td colspan="6">Cargando historial clínico...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="admin-modal" data-history-modal hidden data-can-edit={canEdit}>
      <div class="admin-modal__backdrop" data-close-history-panel></div>

      <aside
        class="admin-modal__content admin-panel admin-panel--history"
        data-history-panel
        hidden
        role="dialog"
        aria-modal="true"
        aria-labelledby="history-modal-title"
        tabindex="-1"
        data-can-edit={canEdit}
      >
        <h2 id="history-modal-title" data-history-panel-title>Historial clínico</h2>
        <p class="admin-panel__description" data-history-panel-description>
          Selecciona un registro para consultarlo o registra nuevos antecedentes desde el listado.
        </p>
        <p class="admin-panel__notice" data-history-readonly hidden>
          Este registro forma parte del expediente clínico y no se puede modificar. Usa “Registrar
          historial” para añadir nueva información sobre el paciente.
        </p>

        <div class="admin-panel__meta">
          <dl class="admin-panel__meta-row">
            <div>
              <dt>Paciente</dt>
              <dd data-history-meta-patient>-</dd>
            </div>
            <div>
              <dt>Documento</dt>
              <dd data-history-meta-document>-</dd>
            </div>
            <div>
              <dt>Doctor responsable</dt>
              <dd data-history-meta-doctor>-</dd>
            </div>
            <div>
              <dt>Fecha del registro</dt>
              <dd data-history-meta-entry>-</dd>
            </div>
          </dl>

          <dl class="admin-panel__meta-row">
            <div>
              <dt>Correo del paciente</dt>
              <dd data-history-meta-email>-</dd>
            </div>
            <div>
              <dt>Teléfono</dt>
              <dd data-history-meta-phone>-</dd>
            </div>
          </dl>

          <div class="admin-panel__attachments" data-history-attachments-meta hidden>
            <div class="admin-panel__attachments-info">
              <span class="admin-panel__attachments-count" data-history-attachments-count>
                Sin archivos adjuntos
              </span>
              <span class="admin-panel__attachments-hint">
                Consulta y descarga archivos desde el visor dedicado.
              </span>
            </div>
            <button
              type="button"
              class="admin-button admin-button--secondary admin-button--compact"
              data-open-history-attachments
            >
              Ver archivos adjuntos
            </button>
          </div>
        </div>

        <section class="history-timeline" data-history-timeline hidden>
          <header class="history-timeline__header">
            <h3>Registros del paciente</h3>
            <span class="history-timeline__count" data-history-timeline-count>-</span>
          </header>
          <ol class="history-timeline__list" data-history-timeline-list></ol>
        </section>

  <form id="history-form" class="admin-form" novalidate data-can-edit={canEdit}>
          <div class="admin-panel__fields" data-history-patient-field>
            <label class="admin-field">
              <span>Paciente</span>
              <select name="patientId" data-history-patient-select required>
                <option value="">Selecciona un paciente</option>
              </select>
            </label>
          </div>

          <label class="admin-field">
            <span>Fecha del registro</span>
            <input type="datetime-local" name="entryDate" data-history-entry-date />
          </label>

          <label class="admin-field">
            <span>Motivo o diagnóstico</span>
            <textarea name="medicalInform" rows="4" data-history-medical-inform required></textarea>
          </label>

          <label class="admin-field">
            <span>Tratamiento</span>
            <textarea name="treatment" rows="3" data-history-treatment></textarea>
          </label>

          <label class="admin-field">
            <span>Receta</span>
            <textarea name="recipe" rows="3" data-history-recipe></textarea>
          </label>

          <div class="admin-field admin-field--attachments" data-history-attachments-field>
            <span>Archivos adjuntos</span>
            <input
              type="file"
              multiple
              accept=".pdf,image/png,image/jpeg"
              data-history-attachments-input
            />
            <p class="admin-field__hint">PDF, PNG o JPG. Máximo 5 archivos de hasta 10MB.</p>
            <ul class="attachments-preview" data-history-attachments-preview></ul>
          </div>

          <p id="history-feedback" class="admin-feedback" role="status"></p>

          <div class="admin-actions" data-history-actions>
            <button
              type="submit"
              class="admin-button admin-button--primary"
              data-history-submit
              hidden={!canEdit}
            >
              Guardar registro
            </button>
            <button type="button" class="admin-button admin-button--ghost" data-close-history-panel>
              {canEdit ? 'Cancelar' : 'Cerrar'}
            </button>
          </div>
        </form>
      </aside>
    </div>

    <div class="history-attachments-overlay" data-history-attachments-overlay hidden>
      <div class="history-attachments-overlay__backdrop" data-close-history-attachments></div>
      <section class="history-attachments-overlay__content" role="dialog" aria-modal="true">
        <header class="history-attachments-overlay__header">
          <div>
            <h3>Archivos adjuntos</h3>
            <span data-history-attachments-overlay-count>0 archivos</span>
          </div>
          <button
            type="button"
            class="admin-button admin-button--ghost admin-button--compact"
            data-close-history-attachments
          >
            Cerrar
          </button>
        </header>
        <div class="history-attachments-overlay__body">
          <ul class="history-attachments-overlay__list" data-history-attachments-items></ul>
          <div class="history-attachments-overlay__preview">
            <p class="history-attachments-overlay__placeholder" data-history-attachments-preview-empty>
              Selecciona un archivo para ver la vista previa.
            </p>
            <div
              class="history-attachments-overlay__preview-canvas"
              data-history-attachments-preview-canvas
            ></div>
            <div
              class="history-attachments-overlay__preview-actions"
              data-history-attachments-preview-actions
              hidden
            >
              <a
                class="admin-button admin-button--ghost admin-button--compact"
                target="_blank"
                rel="noopener noreferrer"
                data-history-attachments-preview-open
              >
                Ver en pestaña nueva
              </a>
              <a
                class="admin-button admin-button--primary admin-button--compact"
                data-history-attachments-preview-download
                download
              >
                Descargar
              </a>
            </div>
          </div>
        </div>
      </section>
    </div>
  </section>
</Layout>

<style>
  .admin-shell {
    width: 100%;
    max-width: 72rem;
    margin: 0 auto;
    display: grid;
    gap: clamp(1.75rem, 4vw, 2.5rem);
    padding: clamp(2rem, 5vw, 3rem);
    background: var(--hero-bg);
    border-radius: 28px;
    box-shadow: var(--hero-card-shadow);
  }

  .admin-shell--panel-open {
    background: var(--color-admin-surface-alt, var(--hero-bg));
  }

  .admin-header {
    display: grid;
    gap: 0.6rem;
    text-align: center;
  }

  .admin-header h1 {
    margin: 0;
    font-size: 1.75rem;
  }

  .admin-subtitle {
    margin: 0;
    color: var(--color-muted);
    font-size: 1.05rem;
  }

  .admin-grid {
    display: grid;
    gap: 1.5rem;
    width: 100%;
  }

  @media (min-width: 960px) {
    .admin-grid--with-panel {
      grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
      align-items: start;
      gap: 1.75rem;
    }
  }

  .admin-card,
  .admin-panel {
    background: var(--color-admin-surface);
    border: 1px solid var(--color-admin-border);
    border-radius: 1.25rem;
    padding: clamp(1.5rem, 3vw, 2rem);
    box-shadow: var(--shadow-card);
  }

  .admin-panel {
    min-height: 100%;
  }

  .admin-panel__description {
    margin: 0.5rem 0 1.25rem;
    color: var(--color-muted);
    font-size: 0.95rem;
  }

  .admin-panel__notice {
    margin: 0 0 1rem;
    padding: 0.85rem 1rem;
    border-radius: 0.85rem;
    background: rgba(37, 99, 235, 0.12);
    border: 1px solid rgba(37, 99, 235, 0.25);
    color: #1d4ed8;
    font-size: 0.9rem;
    font-weight: 600;
  }

  .admin-toolbar--history {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    justify-content: center;
    align-items: center;
  }

  .admin-toolbar--history .admin-search {
    flex: 1 1 320px;
  }

  .admin-toolbar--history .admin-button {
    flex: 0 0 auto;
  }

  :global(.records-table--history thead th:first-child),
  :global(.records-table--history tbody td:first-child) {
    text-align: left;
  }

  :global(.records-table--history thead th:nth-child(2)),
  :global(.records-table--history tbody td:nth-child(2)),
  :global(.records-table--history thead th:nth-child(6)),
  :global(.records-table--history tbody td:nth-child(6)) {
    text-align: center;
  }

  :global(.records-table--history thead th:nth-child(3)),
  :global(.records-table--history tbody td:nth-child(3)),
  :global(.records-table--history thead th:nth-child(4)),
  :global(.records-table--history tbody td:nth-child(4)),
  :global(.records-table--history thead th:nth-child(5)),
  :global(.records-table--history tbody td:nth-child(5)) {
    text-align: left;
  }

  :global(.records-table--history tbody td) {
    vertical-align: top;
  }

  :global(.records-row--history) {
    cursor: pointer;
  }

  :global(.records-row--history td:first-child .records-entry),
  :global(.records-row--history td:nth-child(3) .records-entry),
  :global(.records-row--history td:nth-child(4) .records-entry),
  :global(.records-row--history td:nth-child(5) .records-entry) {
    justify-items: flex-start;
  }

  :global(.records-row--history td:nth-child(2) .records-entry),
  :global(.records-row--history td:nth-child(6) .records-entry) {
    justify-items: center;
  }

  .admin-history-text {
    max-height: 4.75rem;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    text-align: left;
    white-space: pre-line;
  }

  .admin-panel--history {
    display: grid;
    gap: 1.5rem;
    justify-items: stretch;
    align-content: start;
  }

  .admin-panel--history select,
  .admin-panel--history textarea {
    width: 100%;
  }

  .admin-panel--history textarea {
    min-height: 7rem;
  }

  .admin-panel--history .admin-panel__meta {
    background: var(--color-admin-row-hover);
    border-radius: 0.85rem;
    padding: 1.25rem 1.5rem;
    display: grid;
    gap: 1rem;
  }

  .admin-panel--history .admin-panel__meta-row {
    display: grid;
    gap: 1rem;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    justify-items: center;
  }

  .admin-panel__attachments {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.12), rgba(37, 99, 235, 0.2));
    border-radius: 0.85rem;
    padding: 1rem 1.25rem;
    border: 1px solid rgba(37, 99, 235, 0.25);
  }

  .admin-panel__attachments-info {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
  }

  .admin-panel__attachments-count {
    font-size: 1rem;
    font-weight: 700;
    color: #1d4ed8;
    letter-spacing: 0.01em;
  }

  .admin-panel__attachments-hint {
    font-size: 0.85rem;
    color: rgba(15, 23, 42, 0.7);
  }

  .admin-panel--history .admin-panel__meta-row > div {
    display: grid;
    gap: 0.35rem;
    text-align: center;
  }

  .admin-panel--history .admin-panel__meta-row dt {
    font-size: 0.8rem;
    text-transform: uppercase;
    color: var(--color-muted);
    letter-spacing: 0.08em;
  }

  .admin-panel--history .admin-panel__meta-row dd {
    margin: 0;
    font-weight: 600;
  }

  .admin-field--attachments input[type='file'] {
    width: 100%;
    border: 1px dashed var(--color-admin-border);
    border-radius: 0.75rem;
    padding: 0.75rem;
    background: rgba(15, 23, 42, 0.02);
    cursor: pointer;
  }

  .admin-field__hint {
    margin: 0.5rem 0 0;
    font-size: 0.85rem;
    color: var(--color-muted);
  }

  .attachments-preview {
    list-style: none;
    display: grid;
    gap: 0.35rem;
    margin: 0.75rem 0 0;
    padding: 0;
  }

  .attachments-preview__item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    background: rgba(37, 99, 235, 0.08);
    border: 1px solid rgba(37, 99, 235, 0.2);
    border-radius: 0.75rem;
    padding: 0.65rem 0.85rem;
  }

  .attachments-preview__meta {
    display: grid;
    gap: 0.25rem;
  }

  .attachments-preview__name {
    font-weight: 600;
    font-size: 0.92rem;
    word-break: break-word;
  }

  .attachments-preview__info {
    font-size: 0.8rem;
    color: var(--color-muted);
  }

  .history-attachments-overlay {
    position: fixed;
    inset: 0;
    display: grid;
    place-items: center;
    z-index: 1200;
    isolation: isolate;
  }

  .history-attachments-overlay__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(15, 23, 42, 0.55);
    backdrop-filter: blur(3px);
  }

  .history-attachments-overlay__content {
    position: relative;
    width: min(900px, 92vw);
    max-height: 90vh;
    background: radial-gradient(circle at top right, rgba(37, 99, 235, 0.08), transparent 55%),
      var(--color-admin-surface);
    border-radius: 1.5rem;
    border: 1px solid rgba(148, 163, 184, 0.35);
    box-shadow: 0 32px 64px -36px rgba(15, 23, 42, 0.45);
    padding: clamp(1.25rem, 3vw, 1.75rem);
    display: grid;
    gap: 1.5rem;
    z-index: 1;
  }

  .history-attachments-overlay__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
    padding: 0.85rem 1rem;
    border-radius: 1rem;
    background: rgba(37, 99, 235, 0.06);
    border: 1px solid rgba(37, 99, 235, 0.14);
  }

  .history-attachments-overlay__header h3 {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 700;
    letter-spacing: -0.01em;
  }

  .history-attachments-overlay__header > div {
    display: grid;
    gap: 0.35rem;
  }

  [data-history-attachments-overlay-count] {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    padding: 0.3rem 0.75rem;
    border-radius: 999px;
    background: rgba(37, 99, 235, 0.14);
    color: #1d4ed8;
    font-size: 0.82rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .history-attachments-overlay__body {
    display: grid;
    grid-template-columns: minmax(0, 2fr) minmax(0, 3fr);
    gap: 1.5rem;
  }

  .history-attachments-overlay__list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 0.75rem;
    overflow-y: auto;
    max-height: 60vh;
    padding-right: 0.35rem;
  }

  .history-attachments-overlay__item-button {
    width: 100%;
    text-align: left;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.85rem;
    border: 1px solid rgba(148, 163, 184, 0.35);
    background: rgba(255, 255, 255, 0.85);
    border-radius: 1rem;
    padding: 0.9rem 1.1rem;
    cursor: pointer;
    border-left: 3px solid transparent;
    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease,
      background 0.2s ease;
    color: inherit;
    box-shadow: 0 14px 28px -24px rgba(15, 23, 42, 0.4);
  }

  .history-attachments-overlay__item-button:hover,
  .history-attachments-overlay__item-button:focus-visible {
    transform: translateY(-2px);
    box-shadow: 0 18px 36px -22px rgba(37, 99, 235, 0.5);
    border-color: rgba(37, 99, 235, 0.45);
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.18), rgba(96, 165, 250, 0.1));
  }

  .history-attachments-overlay__item-button--active {
    border-color: rgba(37, 99, 235, 0.55);
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.24), rgba(96, 165, 250, 0.16));
    box-shadow: 0 22px 42px -24px rgba(37, 99, 235, 0.55);
    border-left-color: rgba(37, 99, 235, 0.9);
  }

  .history-attachments-overlay__item-title {
    font-weight: 700;
    font-size: 0.92rem;
    word-break: break-word;
    color: var(--records-text-strong);
    letter-spacing: 0.01em;
  }

  .history-attachments-overlay__item-content {
    display: grid;
    gap: 0.3rem;
    flex: 1 1 auto;
  }

  .history-attachments-overlay__item-meta {
    font-size: 0.78rem;
    color: rgba(15, 23, 42, 0.7);
    letter-spacing: 0.02em;
  }

  .history-attachments-overlay__item-button::after {
    content: '↗';
    font-size: 0.9rem;
    color: #1d4ed8;
    font-weight: 700;
    margin-left: 0.75rem;
  }

  .history-attachments-overlay__item-button--active::after {
    color: #1e3a8a;
  }

  .history-attachments-overlay__item-button--active .history-attachments-overlay__item-title {
    color: #1e3a8a;
  }

  .history-attachments-overlay__preview {
    display: grid;
    gap: 1rem;
    background: rgba(37, 99, 235, 0.06);
    border: 1px solid rgba(37, 99, 235, 0.2);
    border-radius: 1.1rem;
    padding: 1.15rem;
    min-height: 260px;
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.12);
  }

  .history-attachments-overlay__preview-canvas {
    min-height: 200px;
    display: grid;
    place-items: center;
    overflow: hidden;
    border-radius: 0.95rem;
    background: rgba(15, 23, 42, 0.04);
    border: 1px solid rgba(148, 163, 184, 0.35);
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
  }

  .history-attachments-overlay__preview-canvas img,
  .history-attachments-overlay__preview-canvas iframe,
  .history-attachments-overlay__preview-canvas embed {
    width: 100%;
    height: 100%;
    border: none;
    object-fit: contain;
    background: var(--color-admin-surface);
    border-radius: 0.95rem;
    box-shadow: 0 16px 38px -26px rgba(15, 23, 42, 0.55);
  }

  .history-attachments-overlay__placeholder {
    margin: 0;
    font-size: 0.88rem;
    color: rgba(15, 23, 42, 0.7);
    background: rgba(255, 255, 255, 0.65);
    border-radius: 0.75rem;
    padding: 0.6rem 0.85rem;
    box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.25);
  }

  .history-attachments-overlay__preview-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    justify-content: flex-end;
  }

  .history-timeline {
    display: grid;
    gap: 1.25rem;
    background: rgba(37, 99, 235, 0.08);
    border: 1px solid rgba(37, 99, 235, 0.18);
    border-radius: 1.2rem;
    padding: 1.5rem;
    box-shadow: 0 24px 48px -32px rgba(37, 99, 235, 0.45);
  }

  .history-timeline__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 1rem 1.25rem;
    border-radius: 1rem;
    background: var(--color-admin-surface);
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.12);
  }

  .history-timeline__header h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--records-text-strong);
    letter-spacing: -0.01em;
  }

  .history-timeline__count {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    padding: 0.35rem 0.85rem;
    border-radius: 999px;
    background: rgba(37, 99, 235, 0.16);
    color: #1d4ed8;
    font-size: 0.82rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .history-timeline__list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 1.25rem;
  }

  .history-timeline__item {
    position: relative;
    border-radius: 1.1rem;
    border: 1px solid var(--color-admin-border);
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.05), rgba(37, 99, 235, 0.1));
    box-shadow: 0 18px 34px -24px rgba(37, 99, 235, 0.45);
    transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    overflow: hidden;
    padding: 1.15rem;
  }

  .history-timeline__item:hover,
  .history-timeline__item:focus-within {
    transform: translateY(-2px);
    box-shadow: 0 24px 48px -26px rgba(37, 99, 235, 0.55);
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.18), rgba(37, 99, 235, 0.24));
  }

  .history-timeline__item + .history-timeline__item::before {
    content: '';
    position: absolute;
    top: -0.65rem;
    left: 1rem;
    right: 1rem;
    height: 1px;
    background: linear-gradient(90deg, rgba(148, 163, 184, 0), rgba(148, 163, 184, 0.5), rgba(148, 163, 184, 0));
  }

  .history-timeline__grid {
    display: grid;
    gap: 1.1rem;
  }

  @media (min-width: 1080px) {
    .history-timeline__grid {
      grid-template-columns: minmax(240px, 1fr) minmax(320px, 1.35fr) minmax(220px, 0.9fr);
      align-items: start;
    }
  }

  .history-timeline__cell {
    padding: 1.2rem 1.4rem;
    display: grid;
    gap: 0.8rem;
    background: rgba(255, 255, 255, 0.88);
    border-radius: 1rem;
    border: 1px solid rgba(148, 163, 184, 0.35);
    box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.12);
  }

  @media (max-width: 1079px) {
    .history-timeline__cell {
      padding: 1rem 1.1rem;
    }
  }

  .history-timeline__cell--meta {
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(37, 99, 235, 0.04));
  }

  .history-timeline__cell--details {
    background: linear-gradient(135deg, rgba(148, 163, 184, 0.12), rgba(37, 99, 235, 0.05));
  }

  .history-timeline__cell--attachments {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(37, 99, 235, 0.04));
  }

  .history-timeline__entry {
    justify-items: flex-start;
    gap: 0.45rem;
  }

  .history-timeline__entry .records-entry-header {
    align-items: center;
    gap: 0.65rem;
  }

  .history-timeline__entry .records-entry-title {
    font-size: 1.05rem;
  }

  .history-timeline__entry .records-entry-line--muted {
    font-size: 0.9rem;
    color: var(--records-text-muted);
  }

  .history-timeline__details {
    display: grid;
    gap: 0.6rem;
  }

  .history-timeline__detail {
    display: grid;
    gap: 0.35rem;
  }

  .history-timeline__detail dt {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--records-text-muted);
    font-weight: 700;
  }

  .history-timeline__detail dd {
    margin: 0;
    font-size: 0.95rem;
    color: var(--records-text-strong);
    line-height: 1.55;
    white-space: pre-line;
  }

  .history-timeline__attachments {
    display: grid;
    gap: 0.75rem;
    align-content: start;
  }

  .history-timeline__attachments-list {
    list-style: none;
    margin: 0;
    padding: 0;
    display: grid;
    gap: 0.75rem;
  }

  .history-timeline__attachments-empty {
    display: inline-flex;
    align-items: center;
    justify-content: flex-start;
    padding: 0.8rem 1rem;
    border-radius: 0.9rem;
    border: 1px dashed rgba(148, 163, 184, 0.45);
    background: rgba(148, 163, 184, 0.16);
    color: var(--records-text-muted);
    font-weight: 600;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }

  .history-timeline__attachment-item {
    display: block;
  }

  .history-timeline__attachment-chip {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.65rem;
    padding: 0.8rem 1rem;
    border-radius: 0.95rem;
    border: 1px solid rgba(59, 130, 246, 0.28);
    background: rgba(59, 130, 246, 0.12);
    box-shadow: 0 16px 32px -24px rgba(37, 99, 235, 0.4);
    width: 100%;
  }

  .history-timeline__attachment-name {
    font-weight: 700;
    font-size: 0.9rem;
    color: #0f172a;
    word-break: break-word;
    flex: 1 1 auto;
  }

  .history-timeline__attachment-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 2.5rem;
    padding: 0.28rem 0.65rem;
    font-size: 0.7rem;
    font-weight: 800;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #1d4ed8;
    background: rgba(37, 99, 235, 0.18);
    border-radius: 999px;
    border: 1px solid rgba(37, 99, 235, 0.3);
    flex-shrink: 0;
  }

  :global(.history-timeline__attachment-actions) {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: flex-start;
    gap: 0.6rem;
    margin-top: 0;
    margin-left: 0;
  }

  :global(.history-timeline__attachment-action) {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.35rem;
    padding: 0.45rem 1.1rem;
    border-radius: 999px;
    border: none;
    font-size: 0.78rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    background: rgba(37, 99, 235, 0.16);
    color: #1d4ed8;
    border: 1px solid rgba(37, 99, 235, 0.4);
    box-shadow: 0 10px 22px -18px rgba(37, 99, 235, 0.45);
    transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease, color 0.18s ease;
    text-decoration: none;
  }

  :global(.history-timeline__attachment-action:hover),
  :global(.history-timeline__attachment-action:focus-visible) {
    transform: translateY(-1px);
    box-shadow: 0 16px 30px -18px rgba(37, 99, 235, 0.55);
    background: rgba(37, 99, 235, 0.24);
    color: #1e3a8a;
  }

  :global(.history-timeline__attachment-action--primary) {
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.26), rgba(59, 130, 246, 0.2));
    color: #fff;
    border-color: rgba(37, 99, 235, 0.65);
    box-shadow: 0 18px 34px -20px rgba(37, 99, 235, 0.55);
  }

  :global(.history-timeline__attachment-action--primary:hover),
  :global(.history-timeline__attachment-action--primary:focus-visible) {
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.36), rgba(59, 130, 246, 0.28));
    color: #f8fafc;
    box-shadow: 0 22px 42px -20px rgba(37, 99, 235, 0.6);
  }

  .admin-form {
    display: grid;
    gap: 1rem;
  }

  .admin-field {
    display: grid;
    gap: 0.5rem;
  }

  .admin-field input,
  .admin-field textarea,
  .admin-field select {
    border: 1px solid var(--color-admin-border);
    border-radius: 0.75rem;
    padding: 0.75rem;
    background: var(--color-card-bg);
    font: inherit;
    color: inherit;
  }

  .admin-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  :global(.admin-button) {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.4rem;
    border-radius: 1rem;
    padding: 0.75rem 1.4rem;
    min-height: 2.75rem;
    font-weight: 600;
    font-size: 0.95rem;
    letter-spacing: 0.01em;
    cursor: pointer;
    border: none;
    transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
  }

  :global(.admin-button--primary) {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: #fff;
    box-shadow: 0 18px 30px -16px rgba(37, 99, 235, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.25);
  }

  :global(.admin-button--ghost) {
    background: transparent;
    border: 1px solid var(--color-admin-border);
    color: inherit;
  }

  :global(.admin-button--primary:disabled) {
    opacity: 0.7;
    cursor: wait;
    box-shadow: none;
    border-color: transparent;
  }

  :global(.admin-button:not(:disabled):hover),
  :global(.admin-button:not(:disabled):focus-visible) {
    transform: translateY(-2px);
    box-shadow: 0 18px 30px -18px rgba(37, 99, 235, 0.45);
  }

  .admin-feedback {
    min-height: 1.25rem;
    font-size: 0.85rem;
  }

  .admin-feedback--success {
    color: #0f766e;
  }

  .admin-feedback--error {
    color: #dc2626;
  }

  :global(.records-row--history:hover .admin-row-hint),
  :global(.records-row--history:focus-within .admin-row-hint) {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: #fff;
  }

  :global(.admin-row-hint) {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.25rem 0.6rem;
    border-radius: 999px;
    background: rgba(37, 99, 235, 0.14);
    color: #1d4ed8;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    transition: background 0.18s ease, color 0.18s ease;
    margin-top: 0.75rem;
    align-self: flex-start;
    justify-self: flex-start;
  }

  :global(.admin-row-hint)::after {
    content: '↗';
    font-size: 0.85rem;
  }

  .admin-panel--history[data-mode="create"] [data-history-panel-title]::after {
    content: ' (nuevo)';
    font-size: 0.85rem;
    color: var(--color-muted);
    margin-left: 0.25rem;
  }

  .admin-modal {
    position: fixed;
    inset: 0;
    display: grid;
    place-items: center;
    padding: clamp(1.5rem, 5vw, 3rem);
    z-index: 1000;
    isolation: isolate;
  }

  .admin-modal[hidden] {
    display: none;
  }

  .admin-modal__backdrop {
    position: absolute;
    inset: 0;
    background: rgba(15, 23, 42, 0.55);
    backdrop-filter: blur(8px);
  }

  .admin-modal__content {
    position: relative;
    width: min(960px, 100%);
    max-height: min(90vh, 960px);
    overflow-y: auto;
  }

  .admin-modal__content:focus {
    outline: none;
  }

  @media (max-width: 640px) {
    .admin-toolbar--history {
      flex-direction: column;
      align-items: stretch;
    }

    .admin-toolbar--history .admin-button {
      width: 100%;
    }

    .admin-modal {
      padding: 0;
    }

    .admin-modal__content {
      width: 100%;
      max-height: 100vh;
      border-radius: 0;
      padding: clamp(1.5rem, 6vw, 2rem);
    }

    .history-attachments-overlay__body {
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .history-attachments-overlay__list {
      max-height: 40vh;
    }
  }
</style>

<script type="module" src={medicalHistoryClient}></script>
