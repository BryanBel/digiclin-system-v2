---
import AuthUnprotected from "../features/auth/AuthUnprotected.astro";
import Layout from "../layouts/Layout.astro";

const envBackend = (import.meta.env.PUBLIC_BACKEND_URL ?? '').trim();
const devBackend = import.meta.env.DEV ? 'http://localhost:3000' : '';
const currentOrigin = Astro.url?.origin ?? '';
const backendEndpoint = envBackend || devBackend || currentOrigin;
---

<Layout title="DigiClin | Inicia sesión">
  <AuthUnprotected>
    <section class="auth-shell">
      <article class="auth-card">
        <figure class="auth-illustration" aria-hidden="true">
          <img 
            src="/login-illustration.png"
            alt=""
            class="auth-illustration__image auth-illustration__image--login"
          />
        </figure>
        <div class="auth-content login-panel">
          <header class="auth-header">
            <span class="auth-brand">
              <svg
                aria-hidden="true"
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="1.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path d="M12 22c5-2 8-5.33 8-10V7l-8-4-8 4v5c0 4.67 3 8 8 10Z"
                ></path>
                <path d="M9 11.5 11.25 14 15 10"></path>
              </svg>
              DigiClin
            </span>
            <h1 class="auth-heading">Bienvenido de nuevo</h1>
            <p class="auth-subheading">
              Inicia sesión en tu cuenta para continuar.
            </p>
          </header>

          <form
            id="login-form"
            class="auth-form"
            novalidate
            data-backend-url={backendEndpoint}
          >
            <div class="auth-field">
              <label class="auth-label" for="email">Email o usuario</label>
              <div class="auth-input-wrapper">
                <span class="auth-input-icon">
                  <svg
                    class="auth-icon auth-icon--user"
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><path stroke="none" d="M0 0h24v24H0z" fill="none"
                    ></path><path d="M8 7a4 4 0 1 0 8 0a4 4 0 0 0 -8 0"
                    ></path><path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"
                    ></path></svg
                  >
                </span>
                <input
                  class="auth-input"
                  type="email"
                  id="email"
                  name="email"
                  placeholder="Introduce tu email o nombre de usuario"
                />
              </div>
            </div>

            <div class="auth-field">
              <label class="auth-label" for="password">Contraseña</label>
              <div class="auth-input-wrapper">
                <span class="auth-input-icon">
                  <svg
                    class="auth-icon auth-icon--lock"
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><path stroke="none" d="M0 0h24v24H0z" fill="none"
                    ></path><path
                      d="M5 13a2 2 0 0 1 2 -2h10a2 2 0 0 1 2 2v6a2 2 0 0 1 -2 2h-10a2 2 0 0 1 -2 -2v-6z"
                    ></path><path d="M11 16a1 1 0 1 0 2 0a1 1 0 0 0 -2 0"
                    ></path><path d="M8 11v-4a4 4 0 1 1 8 0v4"></path></svg
                  >
                </span>
                <input
                  class="auth-input"
                  type="password"
                  id="password"
                  name="password"
                  placeholder="Introduce tu contraseña"
                />
                <button
                  type="button"
                  id="toggle-password"
                  class="auth-input-action"
                  aria-label="Mostrar u ocultar contraseña"
                >
                  <svg
                    id="icon-eye"
                    class="auth-input-action-icon auth-input-action-icon--hidden icon icon-tabler icon-tabler-eye"
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><path stroke="none" d="M0 0h24v24H0z" fill="none"
                    ></path><path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0"
                    ></path><path
                      d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6"
                    ></path></svg
                  >
                  <svg
                    id="icon-eye-off"
                    class="auth-input-action-icon icon icon-tabler icon-tabler-eye-off"
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    ><path stroke="none" d="M0 0h24v24H0z" fill="none"
                    ></path><path d="M10.585 10.587a2 2 0 0 0 2.829 2.828"
                    ></path><path
                      d="M16.681 16.673a8.717 8.717 0 0 1 -4.681 1.327c-3.6 0 -6.6 -2 -9 -6c1.272 -2.12 2.712 -3.678 4.32 -4.674m2.86 -1.146a9.055 9.055 0 0 1 1.82 -.18c3.6 0 6.6 2 9 6c-.666 1.11 -1.379 2.067 -2.138 2.87"
                    ></path><path d="M3 3l18 18"></path></svg
                  > 
                </button>
              </div>
            </div>

            <div class="auth-inline-actions">
              <label class="auth-checkbox">
                <input type="checkbox" />
                <span>Recordarme</span>
              </label>
              <a class="auth-link" href="#">¿Olvidé mi contraseña?</a>
            </div>

            <button id="submit-button" type="submit" class="auth-submit"
              >Iniciar sesión</button
            >
            <p id="login-feedback" class="auth-feedback" role="status"></p>
          </form>

          <footer class="auth-footer">
            ¿No tienes una cuenta?
            <a class="auth-link" href="/signup">Regístrate</a>
          </footer>
        </div>
      </article>
    </section>
  </AuthUnprotected>
</Layout>

<script type="module">
  const form = document.querySelector("#login-form");
  const submitButton = document.querySelector("#submit-button");
  const togglePasswordButton = document.querySelector("#toggle-password");
  const passwordInput = document.querySelector("#password");
  const iconEye = document.querySelector("#icon-eye");
  const iconEyeOff = document.querySelector("#icon-eye-off");
  const feedbackEl = document.querySelector("#login-feedback");

  const LINKED_STORAGE_KEY = "digiclinLinkedRequestInfo";

  const env = typeof import.meta !== "undefined" && import.meta?.env ? import.meta.env : {};
  const runtimeOrigin = typeof window !== "undefined" ? window.location.origin : "";
  const datasetBackend =
    form instanceof HTMLFormElement && typeof form.dataset.backendUrl === "string"
      ? form.dataset.backendUrl.trim()
      : "";
  const envBackend = typeof env.PUBLIC_BACKEND_URL === "string" ? env.PUBLIC_BACKEND_URL.trim() : "";
  const devEndpoint = env.DEV === true || env.DEV === "true" ? "http://localhost:3000" : "";

  const baseEndpoint = (() => {
    const candidates = [datasetBackend, envBackend, devEndpoint, runtimeOrigin];
    for (const candidate of candidates) {
      if (candidate) return candidate.replace(/\/$/, "");
    }
    return "";
  })();

  const resolveEndpoint = (path) => {
    if (!path) return baseEndpoint;
    if (/^https?:\/\//i.test(path)) return path;
    const normalized = path.startsWith("/") ? path : `/${path}`;
    return baseEndpoint ? `${baseEndpoint}${normalized}` : normalized;
  };

  const FEEDBACK_CLASSES = {
    success: "auth-feedback--success",
    error: "auth-feedback--error",
    info: "auth-feedback--info",
  };

  const storeLinkedInfo = ({ token, message, status }) => {
    if (typeof window === "undefined" || !token) return;
    try {
      const payload = JSON.stringify({
        token,
        message: message ?? null,
        status: status ?? null,
        timestamp: Date.now(),
      });
      window.sessionStorage.setItem(LINKED_STORAGE_KEY, payload);
    } catch (error) {
      console.warn("No se pudo guardar el estado de vinculación", error);
    }
  };

  const setFeedback = (message, variant = "info") => {
    if (!(feedbackEl instanceof HTMLElement)) return;
    Object.values(FEEDBACK_CLASSES).forEach((className) => feedbackEl.classList.remove(className));
    if (FEEDBACK_CLASSES[variant]) {
      feedbackEl.classList.add(FEEDBACK_CLASSES[variant]);
    }
    feedbackEl.textContent = message ?? "";
  };

  togglePasswordButton?.addEventListener("click", () => {
    if (!(passwordInput instanceof HTMLInputElement)) return;
    const isHidden = passwordInput.type === "password";
    passwordInput.type = isHidden ? "text" : "password";
    iconEye?.classList.toggle("auth-input-action-icon--hidden", !isHidden);
    iconEyeOff?.classList.toggle("auth-input-action-icon--hidden", isHidden);
  });

  const parseErrorMessage = async (response) => {
    const contentType = response.headers.get("content-type") ?? "";
    if (contentType.includes("application/json")) {
      try {
        const data = await response.json();
        if (data && typeof data === "object") {
          return data.error || data.message || null;
        }
      } catch (error) {
        return null;
      }
    } else {
      try {
        const text = await response.text();
        return text || null;
      } catch (error) {
        return null;
      }
    }
    return null;
  };

  const attemptLinkPendingToken = async () => {
    if (typeof window === "undefined") return;
    const pendingToken = window.localStorage.getItem("digiclinPendingLinkToken");
    if (!pendingToken) return;

    try {
      const response = await fetch(resolveEndpoint("/api/appointment-requests/link"), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ token: pendingToken }),
      });

      const contentType = response.headers.get("content-type") ?? "";
      const isJson = contentType.includes("application/json");
      const parsed = isJson
        ? await response.json().catch(() => null)
        : await response.text().catch(() => null);

      if (response.ok) {
        const payload =
          parsed && typeof parsed === "object"
            ? parsed
            : { message: typeof parsed === "string" ? parsed : null };
        storeLinkedInfo({
          token: pendingToken,
          message:
            typeof payload?.message === "string"
              ? payload.message
              : "Tu solicitud se vinculó correctamente a tu cuenta.",
          status: typeof payload?.status === "string" ? payload.status : null,
        });
        window.localStorage.removeItem("digiclinPendingLinkToken");
      } else {
        const message =
          (parsed && typeof parsed === "object" && parsed !== null && (parsed.error || parsed.message)) ||
          (typeof parsed === "string" && parsed) ||
          "No se pudo vincular la solicitud";
        console.warn(message);
      }
    } catch (error) {
      console.warn("Fallo al vincular automáticamente la solicitud", error);
    }
  };

  if (form instanceof HTMLFormElement && submitButton instanceof HTMLButtonElement) {
    const originalButtonText = submitButton.textContent;

    form.addEventListener("submit", async (event) => {
      event.preventDefault();
      setFeedback("", "info");

      if (!(passwordInput instanceof HTMLInputElement)) return;
      const emailInput = form.querySelector("#email");
      const email = emailInput instanceof HTMLInputElement ? emailInput.value.trim() : "";
      const password = passwordInput.value;

      if (!email || !password) {
        setFeedback("Completa tu correo y contraseña para continuar.", "error");
        return;
      }

      submitButton.disabled = true;
      submitButton.textContent = "Iniciando...";

      try {
        const response = await fetch(resolveEndpoint("/api/auth/login"), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ email, password }),
        });

        if (!response.ok) {
          const message =
            (await parseErrorMessage(response)) ||
            "Credenciales incorrectas o problema del servidor.";
          throw new Error(message);
        }

        await attemptLinkPendingToken();

        const nextUrl = new URLSearchParams(window.location.search).get("next");
        window.location.assign(nextUrl || "/");
      } catch (error) {
        const message = error instanceof Error ? error.message : "No se pudo iniciar sesión.";
        setFeedback(message, "error");
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = originalButtonText ?? "Iniciar sesión";
      }
    });
  }
</script>

<style>
  .auth-feedback {
    min-height: 1.5rem;
    margin-top: 0.75rem;
    font-size: 0.875rem;
    color: var(--color-text-muted, #4b5563);
    transition: color 150ms ease, opacity 150ms ease;
  }

  .auth-feedback--success {
    color: var(--color-success, #16a34a);
  }

  .auth-feedback--error {
    color: var(--color-error, #dc2626);
  }

  .auth-feedback--info {
    color: var(--color-info, #2563eb);
  }
</style>
